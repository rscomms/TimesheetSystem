@{
    ViewData["Title"] = "Home Page";
    var errorMessage = TempData["ErrorMessage"];
    var successMessage = TempData["SuccessMessage"];
}

@model IEnumerable<Timesheet>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewData["Title"]</title>
    <style>
        /* Remove all margins and paddings from the body and html */

    </style>
</head>
<body>
    <button class="download-btn" onclick="downloadCSV()">Download CSV</button>
    @if (errorMessage != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @errorMessage
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    @if (successMessage != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @successMessage
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    <div class="container">
        <!-- Left Side Form -->
        <div class="form-container">
            <h3>Add Timesheet Entry</h3>
            <form asp-action="Add" method="post" id="timesheetForm" onsubmit="return validateForm()">
                <div>
                    <label for="UserName" style="font-weight: bold;">User Name:</label>
                    <input type="text" id="UserName" name="UserName" required />
                </div>
                <div>
                    <label for="EntryDate" style="font-weight: bold;">Entry Date:</label>
                    <input type="date" id="Date" name="Date" required />
                </div>
                <div>
                    <label for="projectName" style="font-weight: bold;">Project Name:</label>
                    <input type="text" id="ProjectName" name="ProjectName" required />
                </div>
                <div>
                    <label for="description" style="font-weight: bold;">Task Description:</label>
                    <input type="text" id="TaskDesc" name="TaskDesc" required />
                </div>
                <div>
                    <label for="hoursWorked" style="font-weight: bold;">Hours Worked:</label>
                    <input type="number" id="HoursWorked" name="HoursWorked" min="-1" max="8" value="8" />
                    <span id="errorHours" style="color: red; display: none;">Please enter a value greater than 0.</span>
                </div>
                <button type="submit">Add Entry</button>
            </form>
        </div>

        <!-- Right Side Table -->
        <div class="table-container">
            <h3>Timesheet Entries Table</h3>
            <table id="timesheetTable">
                <thead>
                    <tr>
                        <th>Entry Date</th>
                        <th>User Name</th>
                        <th>Project</th>
                        <th>Task Description</th>
                        <th>Hours Worked</th>
                        <th>Total Hours Worked</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var entry in Model)
                    {
                        <tr>
                            <td>@entry.Date.ToShortDateString()</td>
                            <td>@entry.UserName</td>
                            <td>@entry.ProjectName</td>
                            <td>@entry.TaskDesc</td>
                            <td>@entry.HoursWorked</td>
                            <td>@entry.TotalHoursWorked</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
    <script>
        //Validates form fields
        function validateForm() {
            var hoursWorked = document.getElementById("hoursWorked").value;
            var errorHours = document.getElementById("errorHours");

            if (hoursWorked == "") {
                document.getElementById("hoursWorked").value = 8;
                return true;
            }

            if (hoursWorked <= 0) {
                errorHours.style.display = "inline";
                return false;
            } else {
                errorHours.style.display = "none";
                return true;
            }
        }

        //Downloads timesheet table as a CSV file
        function downloadCSV() {
            var table = document.getElementById("timesheetTable");
            var rows = table.rows;
            var csv = [];

            // Iterates through the rows to extract the data
            for (var i = 0; i < rows.length; i++) {
                var cells = rows[i].cells;
                var row = [];
                for (var j = 0; j < cells.length; j++) {
                    row.push('"' + cells[j].innerText.replace(/"/g, '""') + '"');
                }
                csv.push(row.join(','));
            }

            // Creates a link element for downloading
            var csvFile = new Blob([csv.join('\n')], { type: 'text/csv' });
            var link = document.createElement("a");
            link.href = URL.createObjectURL(csvFile);
            link.download = "timesheet_entries.csv";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
